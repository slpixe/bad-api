<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Page - Settings</title>
</head>
<body>
<h1>Admin page - Settings</h1>

<form id="settingsForm">
    <fieldset>
        <legend>Network Settings</legend>
        <div>
            <label for="networkDelay">Network Delay (seconds):</label>
            <input type="range" id="networkDelay" name="networkDelay" required min="0" max="18000">
            <span id="networkDelayValue">?</span> seconds
            <span id="networkDelayStatus"></span> <!-- Status indicator -->
        </div>
    </fieldset>
</form>

<input type="range" id="slider2" min="0" max="100">
<input type="checkbox" id="checkbox1">
<input type="text" id="textInput1">

<script src="http://localhost:3001/socket.io/socket.io.js"></script>
<script>
    // Debounce function
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Example of updating the status indicator
    function updateStatusIndicator(id, isSuccess) {
    const statusEl = document.getElementById(`${id}Status`);
    if (statusEl) {
        console.log('=aaa', id, isSuccess);
        statusEl.textContent = isSuccess ? '✔️' : '❌';
    }
}

    // const socket = io();
    const socket = io('http://localhost:3001');

    // Track the client-side and server-side values
    const state = {
        networkDelayClient: null,
        networkDelayServer: null,
        slider2Client: null,
        slider2Server: null,
        checkbox1Client: null,
        checkbox1Server: null,
        textInput1Client: null,
        textInput1Server: null,
    };

    // Elements to sync
    const elements = [
        { id: 'networkDelay', event: 'input', type: 'range' },
        { id: 'slider2', event: 'input', type: 'range' },
        { id: 'checkbox1', event: 'change', type: 'checkbox' },
        { id: 'textInput1', event: 'input', type: 'text' }
    ];

    // Function to sync element value with server
    function syncElement(element) {
        const el = document.getElementById(element.id);

        const emitChange = debounce(() => {
            const value = element.type === 'checkbox' ? el.checked : el.value;
            state[`${element.id}Client`] = value; // Save the client-side value
            socket.emit('elementChanged', { id: element.id, value });
        }, 300); // Adjust the delay as necessary

        el.addEventListener(element.event, emitChange);

        // Update display of networkDelay value
        // if (element.id === 'networkDelay') {
        //     el.addEventListener('input', () => {
        //         document.getElementById('networkDelayValue').textContent = el.value;
        //     });
        // }
    }

    // Initialize all elements to sync
    elements.forEach(element => {
        syncElement(element);
    });

    // Listen for updates from server
    socket.on('elementUpdate', (data) => {
        const el = document.getElementById(data.id);
        if (el) {
            if (data.type === 'checkbox') {
                el.checked = data.value;
            } else {
                el.value = data.value;
                // Update display of networkDelay value from server update
                // if (data.id === 'networkDelay') {
                //     document.getElementById('networkDelayValue').textContent = data.value;
                // }
            }

            // Save the server-side value and compare it with the client-side value
            state[`${data.id}Server`] = data.value;
            if (state[`${data.id}Client`] !== null && state[`${data.id}Client`] === data.value) {
                console.log(`${data.id} has been successfully updated on the server`);
                // Here you can update the UI to reflect successful updates
            }
        }
        const isSuccess = state[`${data.id}Client`] === data.value;
        updateStatusIndicator(data.id, isSuccess);

        console.log('=state', state);
    });
</script>
</body>
</html>
