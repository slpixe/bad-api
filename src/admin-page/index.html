<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Page - Settings</title>
</head>
<body>
<h1>Admin page - Settings</h1>

<form id="settingsForm">
    <fieldset>
        <legend>Network Settings</legend>
        <div>
            <label for="networkDelay">Network Delay (seconds):</label>
            <input type="range" id="networkDelay" name="networkDelay" required min="0" max="18000">
            <span id="networkDelayValue">?</span> seconds
            <span id="networkDelayStatus"></span> <!-- Status indicator -->
        </div>
    </fieldset>
</form>

<input type="range" id="slider2" min="0" max="100">
<input type="checkbox" id="checkbox1">
<input type="text" id="textInput1">

<script src="http://localhost:3001/socket.io/socket.io.js"></script>
<script>
    // Debounce function
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Example of updating the status indicator
    function updateStatusIndicator(id, isSuccess) {
        const statusEl = document.getElementById(`${id}Status`);
        if (statusEl) {
            console.log('=aaa', id, isSuccess);
            statusEl.textContent = isSuccess ? '✔️' : '❌';
        }
    }

    // Check client and server values and update status indicators
    function checkAndDisplayStatus() {
        for (const element of elements) {
            const clientValue = state[`${element.id}Client`];
            const serverValue = state[`${element.id}Server`];
            const statusEl = document.getElementById(`${element.id}Status`);

            if(statusEl) {
                if (clientValue !== null && clientValue === serverValue) {
                    statusEl.textContent = '✔️'; // Values match
                } else {
                    statusEl.textContent = '❌'; // Values do not match
                }
            }
        }
    }

    // const socket = io();
    const socket = io('http://localhost:3001');

    // Track the client-side and server-side values
    const state = {
        networkDelayClient: null,
        networkDelayServer: null,
        slider2Client: null,
        slider2Server: null,
        checkbox1Client: null,
        checkbox1Server: null,
        textInput1Client: null,
        textInput1Server: null,
    };

    // Elements to sync
    const elements = [
        { id: 'networkDelay', event: 'input', type: 'range' },
        { id: 'slider2', event: 'input', type: 'range' },
        { id: 'checkbox1', event: 'change', type: 'checkbox' },
        { id: 'textInput1', event: 'input', type: 'text' }
    ];

    // Function to sync element value with server
    function syncElement(element) {
        const el = document.getElementById(element.id);

        const emitChange = debounce(() => {
            const value = element.type === 'checkbox' ? el.checked : el.value;
            state[`${element.id}Client`] = value; // Save the client-side value
            // socket.emit('elementChanged', { id: element.id, value });
            socket.emit('settingsChanged', { id: element.id, value });
        }, 300); // Adjust the delay as necessary

        el.addEventListener(element.event, emitChange);

        // Update display of networkDelay value
        // if (element.id === 'networkDelay') {
        //     el.addEventListener('input', () => {
        //         document.getElementById('networkDelayValue').textContent = el.value;
        //     });
        // }
    }

    // Initialize all elements to sync
    elements.forEach(element => {
        syncElement(element);
    });

    // Listen for updates from server
    // socket.on('elementUpdate', (data) => {
    //     const el = document.getElementById(data.id);
    //     if (el) {
    //         if (data.type === 'checkbox') {
    //             el.checked = data.value;
    //         } else {
    //             el.value = data.value;
    //             // Update display of networkDelay value from server update
    //             // if (data.id === 'networkDelay') {
    //             //     document.getElementById('networkDelayValue').textContent = data.value;
    //             // }
    //         }
    //
    //         // Save the server-side value and compare it with the client-side value
    //         state[`${data.id}Server`] = data.value;
    //         if (state[`${data.id}Client`] !== null && state[`${data.id}Client`] === data.value) {
    //             console.log(`${data.id} has been successfully updated on the server`);
    //             // Here you can update the UI to reflect successful updates
    //         }
    //     }
    //     const isSuccess = state[`${data.id}Client`] === data.value;
    //     updateStatusIndicator(data.id, isSuccess);
    //
    //     console.log('=state', state);
    // });

    // Listen for updates from server
    socket.on('settingsUpdate', (updatedSettings) => {
        // Update the state with server values
        for (const [id, value] of Object.entries(updatedSettings)) {
            state[`${id}Server`] = value;

            // Update the UI elements with server values
            const el = document.getElementById(id);
            if (el) {
                if (el.type === 'checkbox') {
                    el.checked = value;
                } else {
                    el.value = value;
                    if (id === 'networkDelay') {
                        document.getElementById('networkDelayValue').textContent = value;
                    }
                }
            }
        }

        // Check if client and server values match, and update status indicators
        checkAndDisplayStatus();
    });
</script>
</body>
</html>
